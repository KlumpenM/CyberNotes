# Privilege Escalation

## Overview
Initial access to a compromised server is often through a low-privileged user. To gain full control, privilege escalation is required to achieve root access (Linux) or administrator/SYSTEM access (Windows). Common methods for privilege escalation are discussed below.

---

## PrivEsc Checklists
1. **Checklists and Resources**:
   - **HackTricks**: Excellent checklist for both Linux and Windows PrivEsc.
   - **PayloadsAllTheThings**: Collection of PrivEsc techniques and commands.

2. **Enumeration Scripts**:
   - Linux: `LinEnum`, `linuxprivchecker`.
   - Windows: `Seatbelt`, `JAWS`.
   - **PEASS**: Comprehensive tool for Linux and Windows enumeration.

**Note**: Scripts may trigger antivirus or security monitoring systems. In sensitive environments, manual enumeration may be safer.

Example of running `linpeas.sh` for Linux enumeration:
```bash
./linpeas.sh
```

---

## Common Privilege Escalation Methods

### 1. Kernel Exploits
- Exploit unpatched kernel vulnerabilities.
- Use tools like Google or `searchsploit` to find exploits (e.g., CVE-2016-5195, DirtyCow).
- **Caution**: Kernel exploits may destabilize systems; use carefully in production.

### 2. Vulnerable Software
- Check installed software:
  - Linux: `dpkg -l`
  - Windows: `C:\Program Files`
- Look for outdated software with known vulnerabilities.

### 3. User Privileges
#### a. **Sudo Privileges** (Linux)
- Check sudo permissions:
  ```bash
  sudo -l
  ```
- Exploit permissions:
  - Full sudo access:
    ```bash
    sudo su -
    ```
  - `NOPASSWD` entry for specific commands:
    ```bash
    sudo -u <user> <command>
    ```
- Use resources like GTFOBins for exploiting sudo commands.

#### b. **SUID Files** (Linux)
- Exploitable files with the SUID bit set.

#### c. **Windows Token Privileges**
- Look for misconfigurations allowing privilege escalation.

### 4. Scheduled Tasks
#### a. **Linux Cron Jobs**
- Writeable cron directories:
  - `/etc/crontab`
  - `/etc/cron.d`
  - `/var/spool/cron/crontabs/root`
- Add malicious scripts to trigger reverse shells.

#### b. **Windows Scheduled Tasks**
- Exploit misconfigurations or inject malicious tasks.

### 5. Exposed Credentials
- Look for exposed credentials in files (e.g., configuration files, logs).
- Example of credentials found in a file:
  ```php
  /var/www/html/config.php: $conn = new mysqli(localhost, 'db_user', 'password123');
  ```
- Try reusing passwords for privilege escalation:
  ```bash
  su -
  Password: password123
  ```

### 6. SSH Keys
#### a. **Read Access**:
- Read `/home/user/.ssh/id_rsa` or `/root/.ssh/id_rsa`.
- Use the key to log in:
  ```bash
  ssh root@10.10.10.10 -i id_rsa
  ```

#### b. **Write Access**:
- Add your public key to `/home/user/.ssh/authorized_keys`.
- Generate SSH keys:
  ```bash
  ssh-keygen -f key
  ```
- Copy `key.pub` to the remote server and append to `authorized_keys`.

---

## Tools and Resources
- **HackTricks**: [Linux Privilege Escalation Checklist](https://book.hacktricks.xyz/linux-unix/linux-privilege-escalation-checklist)
- **GTFOBins**: Exploitable commands with sudo privileges.
- **LOLBAS**: Exploitable Windows applications.

---

Privilege escalation techniques require careful consideration and testing in controlled environments. For production systems, always coordinate with clients and follow ethical guidelines.

___
# Questions:
1) SSH into the server above with the provided credentials, and use the '-p xxxxxx' to specify the port shown above. Once you login, try to find a way to move to 'user2', to get the flag in '/home/user2/flag.txt'.
	- This is quite a difficult task, since we need to think outside the box on what we are doing, in this case we start by SSH into the given ip address with the given credentials.
	- After that are we going strait to the folder `/home/user2/` to see if we can `cat flag.txt`. *We can't* :(...
	- Now we need to see what we can do as *user1*:
	  `sudo -l`, here we are seeing that we have the following line:
	  `(user2 : user2) NOPASSWD: /bin/bash`, this means that we (as user1), can **sudo** `/bin/bash` with no password as *user2*.
	- Now we just need to write a bash script that reads the given file, so we can see what's inside *flag.txt*. We can do that with the following script (taken from [here](https://gtfobins.github.io/gtfobins/bash/#file-read))
	  ```bash
		  export LFILE=$1
		  bash -c 'echo "$(<$LFILE)"'
		```
	- If we now type `sudo -u user2 /bin/bash script.sh /home/user2/flag.txt`, we get the flag

	- Alternative we can just write: `sudo -u user2 /bin/bash` and then `cat flag.txt`
2)  Once you gain access to 'user2', try to find a way to escalate your privileges to root, to get the flag in '/root/flag.txt'.
	- Here we shall remember what we have talked about, when it comes to SSH
	- We know that the files either lies in the `/home/user/.ssh/id_rsa` or `/root/.ssh/id_rsa` and for us, it's the latter.
	- Now we remember the sentence: *If we can read the `/root/.ssh/` directory and can read the `id_rsa` file, we can copy it to our machine and use the `-i` flag to log in with it:* 
	- Since we can read it with `cat`, we can copy-paste it to **our own machine** and then chmod it:
	   `sudo chmod 600 id_rsa`
	-  We can now SSH into the target IP again: `ssh -p <port> root@<target ip> -i id_rsa`
	- We now have root access!!!!
	- We just `cat` the *flag.txt*